# День 10. Внешняя память

Расширенная система хранения с персистентной «внешней памятью» для модели:
- Сохранение всей истории диалогов в SQLite или JSON
- Архивирование сообщений (без удаления) при сжатии
- Многоуровневое сжатие (мета-саммари)
- Поиск и извлечение релевантной информации из истории
- Сборка контекста с учётом лимита токенов

Результат:

Telegram-бот с полноценной внешней памятью, которая позволяет модели помнить важную информацию из прошлых разговоров даже когда полная история не помещается в контекст.

## Новые возможности (День 10)

- **Выбор формата хранения**: SQLite (рекомендуется) или JSON
- **Архивирование вместо удаления**: старые сообщения помечаются как неактивные, но остаются в базе
- **Многоуровневое сжатие**: когда саммари накапливается, создаются мета-саммари
- **Поиск в памяти**: бот ищет релевантную информацию в архивированных сообщениях
- **Token budget**: сборка контекста с учётом лимита токенов
- `/summary_on` — включить внешнюю память (без перенастройки)

## Возможности (День 9)

- `/summary` — настройка внешней памяти и сжатия диалога
- `/summary_status` — статус внешней памяти
- `/summary_off` — отключить внешнюю память
- `/summary_now` — принудительно сжать диалог
- `/clear_history` — очистить историю диалога
- Автоматическое сжатие после N сообщений (настраивается пользователем)
- Персональные настройки для каждого пользователя

## Возможности (День 8)

- `/tokens` — управление отчётом о токенах (on/off)
- Автоматический подсчёт токенов для каждого запроса
- Расчёт стоимости в USD на основе тарифов моделей

## Возможности (День 7)

- `/set_model` — выбор модели ИИ из списка доступных
- `/current_model` — просмотр текущей выбранной модели
- Персональные настройки модели для каждого пользователя

## Поддерживаемые модели

| Модель | Описание | Вход ($/1M) | Выход ($/1M) |
|--------|----------|-------------|--------------|
| `gpt-4o` | Самая мощная модель (по умолчанию) | $2.50 | $10.00 |
| `gpt-4.1` | Последняя версия GPT-4 | $2.00 | $8.00 |
| `gpt-4.1-mini` | Быстрая и экономичная версия | $0.40 | $1.60 |
| `gpt-3.5-turbo` | Быстрая модель для простых задач | $0.50 | $1.50 |

## Структура проекта

```
day_10 22.01.2026/
├── bot.py                # Основной файл бота
├── models.py             # Управление моделями (валидация, цены)
├── storage.py            # Хранение настроек пользователей (SQLite)
├── token_usage.py        # Подсчёт токенов и расчёт стоимости
├── conversation_store.py # Хранение истории диалогов (legacy)
├── external_memory.py    # Внешняя память (SQLite + JSON)
├── memory_retrieval.py   # Поиск и сборка контекста
├── summary_manager.py    # Логика сжатия диалога
├── config.py             # API-токены (не в git)
├── requirements.txt      # Зависимости
├── TOKEN_COUNTING.md     # Документация по учёту токенов
├── DIALOG_SUMMARY.md     # Документация по сжатию диалога
├── EXTERNAL_MEMORY.md    # Документация по внешней памяти
└── README.md             # Этот файл
```

## Запуск

```bash
# Создание виртуального окружения (Python 3.12)
python3.12 -m venv venv
source venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt

# Настройка токенов
cp config.example.py config.py
# Заполните токены в config.py

# Запуск бота
python bot.py
```

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Приветствие |
| `/help` | Справка по командам |
| `/set_model` | Выбор модели ИИ |
| `/current_model` | Текущая модель |
| `/tokens` | Статус отчёта о токенах |
| `/tokens on` | Включить отчёт о токенах |
| `/tokens off` | Выключить отчёт о токенах |
| `/summary` | Настроить внешнюю память |
| `/summary_status` | Статус внешней памяти |
| `/summary_on` | Включить внешнюю память |
| `/summary_off` | Отключить внешнюю память |
| `/summary_now` | Принудительно сжать диалог |
| `/clear_history` | Очистить историю диалога |
| `/show_commands` | Список всех команд |

## Внешняя память

### Настройка

1. Отправьте `/summary`
2. Выберите формат хранения:
   - **SQLite** — быстрая база данных (рекомендуется)
   - **JSON** — простой текстовый файл
3. Укажите порог сжатия (1-500 сообщений)
4. Готово! Внешняя память активирована.

### Как это работает

```
Сообщения → [Хранятся в БД] → Достигнут порог N
                                    ↓
                            Создаётся саммари
                                    ↓
                        Сообщения архивируются
                        (НЕ удаляются!)
                                    ↓
                    Накопилось много саммари?
                                    ↓
                        Мета-саммари (уровень 2)
                                    ↓
                    Накопилось много L2?
                                    ↓
                        Мета-мета-саммари (L3)
                                    ...
```

### Сборка контекста

При каждом запросе бот собирает контекст:

1. **Активные саммари** (высший уровень → низший)
2. **Последние 4 пары сообщений** (для локальной связности)
3. **Релевантные фрагменты** (поиск по ключевым словам в архиве)

Всё это укладывается в token budget (~8000 токенов).

### Что сохраняется в саммари

- Цели и предпочтения пользователя
- Ключевые решения и инструкции
- Важные факты (имена, даты, числа)
- Нерешённые вопросы и следующие шаги

Подробнее см. [EXTERNAL_MEMORY.md](EXTERNAL_MEMORY.md)

## Пример статуса

```
**Статус внешней памяти:** включена

Хранилище: **SQLITE**
Порог сжатия: **10** сообщений
Сообщений с последнего сжатия: **5**
До следующего сжатия: **5** сообщений

Всего сообщений: **150**
Архивировано: **140**
Активных сводок: **3**
Макс. уровень сжатия: **2**
```

## Пример отчёта о токенах

```
**Token Usage** (GPT-4o, API):
  Input: 150 tokens
  Output: 200 tokens
  Total: 350 tokens

**Cost (USD):**
  Input: $0.000375
  Output: $0.002000
  Total: $0.002375
```

## Документация

- [EXTERNAL_MEMORY.md](EXTERNAL_MEMORY.md) — полное описание системы внешней памяти
- [TOKEN_COUNTING.md](TOKEN_COUNTING.md) — учёт токенов
- [DIALOG_SUMMARY.md](DIALOG_SUMMARY.md) — сжатие диалога (legacy)
