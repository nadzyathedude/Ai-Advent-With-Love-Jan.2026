# День 8. Учёт токенов и стоимости

Telegram-бот с возможностью выбора модели OpenAI и отслеживанием использования токенов.

## Новые возможности (День 8)

- `/tokens` — управление отчётом о токенах (on/off)
- Автоматический подсчёт токенов для каждого запроса
- Расчёт стоимости в USD на основе тарифов моделей
- Отправка отчёта об использовании после каждого ответа
- Персональные настройки отображения токенов для каждого пользователя

## Возможности (День 7)

- `/set_model` — выбор модели ИИ из списка доступных
- `/current_model` — просмотр текущей выбранной модели
- Персональные настройки модели для каждого пользователя
- Постоянное хранение выбора в SQLite
- Автоматический откат на модель по умолчанию при недоступности

## Поддерживаемые модели

| Модель | Описание | Вход ($/1M) | Выход ($/1M) |
|--------|----------|-------------|--------------|
| `gpt-4o` | Самая мощная модель (по умолчанию) | $2.50 | $10.00 |
| `gpt-4.1` | Последняя версия GPT-4 | $2.00 | $8.00 |
| `gpt-4.1-mini` | Быстрая и экономичная версия | $0.40 | $1.60 |
| `gpt-3.5-turbo` | Быстрая модель для простых задач | $0.50 | $1.50 |

## Структура проекта

```
day_8 21.01.2026/
├── bot.py              # Основной файл бота
├── models.py           # Управление моделями (валидация, цены)
├── storage.py          # Хранение настроек пользователей (SQLite)
├── token_usage.py      # Подсчёт токенов и расчёт стоимости
├── config.py           # API-токены (не в git)
├── requirements.txt    # Зависимости
├── TOKEN_COUNTING.md   # Документация по учёту токенов
└── README.md           # Этот файл
```

## Запуск

```bash
# Создание виртуального окружения (Python 3.12)
python3.12 -m venv venv
source venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt

# Настройка токенов
cp config.example.py config.py
# Заполните токены в config.py

# Запуск бота
python bot.py
```

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Приветствие |
| `/help` | Справка по командам |
| `/set_model` | Выбор модели ИИ |
| `/current_model` | Текущая модель |
| `/tokens` | Статус отчёта о токенах |
| `/tokens on` | Включить отчёт о токенах |
| `/tokens off` | Выключить отчёт о токенах |
| `/show_commands` | Список всех команд |

## Пример отчёта о токенах

После каждого ответа бот отправляет второе сообщение:

```
**Token Usage** (GPT-4o, API):
  Input: 150 tokens
  Output: 200 tokens
  Total: 350 tokens

**Cost (USD):**
  Input: $0.000375
  Output: $0.002000
  Total: $0.002375
```

## Методы подсчёта токенов

1. **API (основной)** — использует данные из ответа OpenAI API
2. **tiktoken (запасной)** — локальная оценка при недоступности API данных

Подробнее см. [TOKEN_COUNTING.md](TOKEN_COUNTING.md)
